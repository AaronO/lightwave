<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<script type="text/javascript" src="/_ah/channel/jsapi"></script>
<title>Lightwave Testing</title>
</head>

<body>
<h1>Hello {{userid}}</h1>

<div>
  <textarea id="t1" style="width:100%">{"type":"permanode"}</textarea><br>
  <input type="submit" value="Send" onclick="create()">
</div>
<br>
<div>
  <textarea id="t2" style="width:100%">{"type":"mutation", "at":1, "op":{"$t":["Hello World"]}}</textarea><br>
  <input type="submit" value="Send" onclick="mutate(JSON.parse(document.getElementById('t2').value))">
</div>
<br>
<div>
  <div>Invite some user</div>
  <textarea id="t3" style="width:50%">b@example.com</textarea><br>
  <input type="submit" value="Send" onclick="invite(perma, document.getElementById('t3').value, 1)">
</div>

<h1>Result</h1>
<div id="out"></div>

<div>Logout <a href="{{logout}}">here</a>
<hr>
<address></address>
<!-- hhmts start --> Last modified: Sun Jul 24 17:52:51 CEST 2011 <!-- hhmts end -->

<script type="text/javascript">
  var tok = "{{token}}";
  var sessionID = "{{session}}";
  var userID = "{{userid}}";
  
  channel = new goog.appengine.Channel('{{token}}');
  socket = channel.open();
  socket.onopen = onOpened;
  socket.onmessage = onMessage;
  socket.onerror = onError;
  socket.onclose = onClose;

  function onOpened() {
    console.log("Opened")
  }

  function onClose() {
    console.log("Closed")
  }

  function onError() {
    console.log("Error")
  }

  function onMessage(msg) {
    console.log("Message: " + msg.data)
    document.getElementById("out").innerText = msg.data
  }

  var perma = ""
  
  function create() {
    var f = function(msg) {
      var response = JSON.parse(msg);
      if ( response.error ) {
        alert(response.error);
        return;
      }
      perma = response.blobref;
      // Receive further updates
      open(perma);
    };
    post("/private/submit", document.getElementById("t1").value, f);
  }

  function open(perma) {
    var f = function(msg) {
      console.log("Got: " + msg)
      var response = JSON.parse(msg);
      if ( !response.ok ) {
        alert(reponse.error);
        return;
      };
      console.log("Opened perma");
    }
    post("/private/open", JSON.stringify({perma:perma, session:sessionID}), f);    
  }

  function invite(perma, user, applyAt) {
    var f = function(msg) {
      console.log("Got: " + msg)
      var response = JSON.parse(msg);
      if ( !response.ok ) {
        alert(reponse.error);
        return;
      };
      console.log("Invited a user");
    }
    var msg = {type: "permission", perma: perma, allow: 1+2, deny:0, action:"invite", user: user, at: applyAt}
    post("/private/submit", JSON.stringify(msg), f);    
  }
  
  function mutate(blob) {
    var f = function(msg) {
      console.log("Got: " + msg)
      var response = JSON.parse(msg);
      if ( !response.ok ) {
        alert(response.error);
        return;
      };
      console.log("Mutation submitted");
    }
    blob.perma = perma;
    post("/private/submit", JSON.stringify(blob), f);
  }

  function post(url, data, f) {
    var xmlHttp = null;
    try {
      // Mozilla, Opera, Safari sowie Internet Explorer (ab v7)
      xmlHttp = new XMLHttpRequest();
    } catch(e) {
      try {
        // MS Internet Explorer (ab v6)
        xmlHttp  = new ActiveXObject("Microsoft.XMLHTTP");
      } catch(e) {
        try {
          // MS Internet Explorer (ab v5)
          xmlHttp  = new ActiveXObject("Msxml2.XMLHTTP");
        } catch(e) {
          xmlHttp  = null;
        }
      }
    }
    if (xmlHttp) {
      xmlHttp.open('POST', url, true);
      xmlHttp.onreadystatechange = function () {
        if (xmlHttp.readyState == 4) {
          document.getElementById("out").innerText = xmlHttp.responseText
          if ( f ) {
            f(xmlHttp.responseText)
          }
       }
    };
    xmlHttp.send(data);
  }
}
</script>
</body> </html>
