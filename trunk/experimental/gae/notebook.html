<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<link rel="stylesheet" href="ui.css">
<link rel="stylesheet" href="notebook.css">
<script type="text/javascript" src="/_ah/channel/jsapi"></script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="notebook.js"></script>
<script type="text/javascript" src="store.js"></script>
<script type="text/javascript" src="transform.js"></script>
<script type="text/javascript" src="compose.js"></script>
<script type="text/javascript" src="apply.js"></script>
<script type="text/javascript" src="editor.js"></script>
<title>Notebook</title>
<style type="text/css">
</style>
</head>

<body>
<!-- <button onclick="toggleQueue()">Test composing</button> -->
<div class="tabs" id="tabs">
  <div class="tab newtab inactivetab" style="left:-3px" onclick="newChapter()">+</div>
</div>
<div class="stack" id="stack">
  <div class="pagecontainer" id="pagecontainer" style="display:none">
    <div class="pagecontrols"><div class="ui-toolbar"><button id="back-to-inbox" onclick="showInbox()">&#x21a9;</button></div> <div class="ui-toolbar"><button>Archive</button><button>Delete</button></div> <div class="ui-toolbar"><button>Label &#x25be;</button><button>Further actions &#x25be;</button></div></div>    
  <div class="page" id="page">
   <div class="vtabs" id="vtabs">
      <div class="newvtab" id="newvtab" onclick="newPage()">New page &#x25be;</div>      
    </div>
    <div class="share" id="share">
      <div class="sharebutton" onclick="showShare(event)">Share this page &#x25be;</span></div>
      <div class="friend friendonline"> 
        <img class="friend-image" src="unknown.png"><div><span class="friend-name">Joe Foo</span><br><span class="friend-id">foo@nowhere.org</span></div> 
      </div> 
      <div class="friend friendaway"> 
        <img class="friend-image" src="unknown.png"><div><span class="friend-name">Dana Bar</span><br><span class="friend-id">dana@somewhere.org</span></div> 
      </div>
      <div class="invitations" id="invitations">Invitations sent</div>
      <div class="friend friendaway"> 
        <img class="friend-image" src="unknown.png"><div><span class="friend-name">Captain Kirk</span><br><span class="friend-id">kirk@starfleet.org</span></div> 
      </div>
    </div>
    <div class="content title" contentEditable="true">Page title</div>
    <div class="content date">Sunday, June 30, 2011<br>23:55</div>
    <div class="content textbox" contentEditable="true">This is some freaking text</div>
  </div>
  </div>
  <div id="inbox" class="inbox">
    <div class="inboxcontrols"><div class="ui-toolbar"><button><input type="checkbox">&#x25be;</button></div> <div class="ui-toolbar"><button>Archive</button><button>Delete</button></div> <div class="ui-toolbar"><button>Label &#x25be;</button><button>Further actions &#x25be;</button></div></div>
 </div>
</div>

<div class="ui-dialog" id="share-dialog" style="z-index:200; position:absolute; visibility:hidden; padding-bottom:10px; left:0px; top:0px;">
  <div class="ui-titlebar"><div onclick="closeShare()" class="ui-titlebar-close-button">&#x2573;</div>Share page with others</div>
  <div class="ui-section-blue" style="padding-top:16px; padding-bottom:16px; padding-left:8px; padding-right:8px;">
   <button style="float:left; margin-right:6px;" onclick="share()">Share</button><input style="font-size:16px; outline:none; display:block;" type="text" class="ui-searchbox" id="share-dialog-input">
  </div>
  <div class="ui-section" style="overflow-y:auto; overflow-x:hidden; height:400px">
  </div>
</div>

<div class="ui-dialog" id="invite-dialog" style="z-index:200; position:absolute; visibility:hidden; padding-bottom:10px; left:25%; top:100px; width:500px; font-size:11pt">
  <div class="ui-titlebar"><div onclick="closeInvite()" class="ui-titlebar-close-button">&#x2573;</div>Send an invitation</div>
  <div class="ui-section-blue" style="padding-top:16px; padding-bottom:16px; padding-left:8px; padding-right:8px;">
   The user is currently not registered at lightwave.<br><br>Lightwave can send an invitation message for you. Edit the invitation message below and then send it.<br><br>
    <textarea id="ui-invite-text" style="width:100%; min-height:300px; font-size:11pt; font-family:courier">
Hi,

someone wants to share a notebook page with you on lightwave.
    
Click here to view it
http://light-wave.appspot.com

If you want to edit or comment the page, you must register at lightwave.
Registration and use is FREE.
    </textarea><br>
    <button style="font-size:11pt" id="ui-send-invite"">Send invitation</button>
  </div>
</div>

<hr>
<address></address>
<!-- hhmts start --> Last modified: Sun Jul 31 13:54:58 CEST 2011 <!-- hhmts end -->

<script type="text/javascript">
var book = new Book("123456", "MyBook");

function newChapter() {
  var c = new Chapter(book, "tmp-" + Math.random().toString(), "Untitled " + (book.chapters.length).toString(), book.chapters.length % 4, book.chapters[book.chapters.length - 1].id);
  var p = new Page(c, "tmp-" + Math.random().toString(), "Untitled Page", null)
  p.pageBlobRef = "tmp-page" + Math.random().toString();
  c.addPage(p);
  var co1 = new PageContent(p, "tmp-title" + Math.random().toString(), "Page title", "title");
  p.addContent(co1);
  var co2 = new PageContent(p, "tmp-content" + Math.random().toString(), "Some text", "textbox");
  p.addContent(co2);
  book.addChapter(c, true);
  store.createChapterEntity(c);
  store.createPage(p);
  store.createContentEntity(co1);
  store.createContentEntity(co2);
}

function newPage() {
  var p;
  if (book.currentChapter.pages.length == 0) {
    p = new Page(book.currentChapter, "tmp-" + Math.random().toString(), "Untitled page " + (book.currentChapter.pages.length + 1).toString(), null);
  } else {
    p = new Page(book.currentChapter, "tmp-" + Math.random().toString(), "Untitled page " + (book.currentChapter.pages.length + 1).toString(), book.currentChapter.pages[book.currentChapter.pages.length - 1].id);
  }
  p.pageBlobRef = "tmp-page" + Math.random().toString();
  book.currentChapter.addPage(p, true);
  var co1 = new PageContent(p, "tmp-title" + Math.random().toString(), "Page title", "title");
  p.addContent(co1);
  var co2 = new PageContent(p, "tmp-content" + Math.random().toString(), "Some text " + Math.random().toString(), "textbox");
  p.addContent(co2);
  store.createPage(p);
  store.createContentEntity(co1);
  store.createContentEntity(co2);
}
</script>

<script type="text/javascript">
var token = "{{token}}";
var sessionID = "{{session}}";
var userID = "{{userid}}";
store.init(userID, sessionID, token);
store.loadBook();
store.loadInbox();

function findPos(obj) {
    var curleft = curtop = 0;
    if (obj.offsetParent) {
	do {
	    curleft += obj.offsetLeft;
	    curtop += obj.offsetTop;
	} while (obj = obj.offsetParent);
    }
    return [curleft,curtop];
}

function showShare(e) {
  var targ;
  if (!e) var e = window.event;
  if (e.target) targ = e.target;
  else if (e.srcElement) targ = e.srcElement;
  if (targ.nodeType == 3) // defeat Safari bug
    targ = targ.parentNode;

  var dlg = document.getElementById("share-dialog");
  var pos = findPos(targ);
  dlg.style.visibility = "visible";
  dlg.style.left = (pos[0] - 8 - dlg.offsetWidth).toString() + "px";
  dlg.style.top = (pos[1] + 2 + targ.offsetHeight).toString() + "px";
}

function closeShare() {
  var dlg = document.getElementById("share-dialog");
  dlg.style.visibility = "hidden";
}

function share() {
  var input = document.getElementById("share-dialog-input");
  if (input.value == "") {
    return;
  }
  if (!book || !book.currentChapter || !book.currentChapter.currentPage) {
    return;
  }
  var username = input.value;
 // Send invitation email
  var inviteByMail = function() {
    closeInvite();
    store.inviteByMail(follower, document.getElementById("ui-invite-text").value)
 };
  var f = function(knownuser) {
    closeShare();
    if (!knownuser) {
      openInvite(username);
      document.getElementById("ui-send-invite").onclick = inviteByMail;
      return;
    }
  };
  // Add as a follower
  var follower = new Follower(book.currentChapter.currentPage, username, null);
  book.currentChapter.currentPage.addInvitation(follower);
  store.invite(follower, f);
}

function openInvite(username) {
  var dlg = document.getElementById("invite-dialog");
  dlg.style.visibility = "visible";
}

function closeInvite() {
  var dlg = document.getElementById("invite-dialog");
  dlg.style.visibility = "hidden";
}

function showInbox() {
  book.inbox.setActivePage(null);
}

function toggleQueue() {
  if (store.paused) {
    store.resumeQueues();
  } else {
    store.pauseQueues();
  }
}
</script>

</body> </html>
