<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<script type="text/javascript" src="/_ah/channel/jsapi"></script>
<title>Lightwave Testing</title>
</head>

<body>
<h1>Hello {{userid}}</h1>

<div>
  <textarea id="t1" style="width:100%">{"type":"permanode"}</textarea><br>
  <input type="submit" value="Send" onclick="create()">
</div>
<br>
<div>
  <textarea id="entity" style="width:100%">Irgendein Text</textarea><br>
  <input type="submit" value="Send" onclick="entity(perma, document.getElementById('entity').value)">
</div>
<br>
<div>
  <textarea id="t2" style="width:100%">{"$t":["Hello World"]}</textarea><br>
  <input type="submit" value="Send" onclick="mutate(perma, entityBlobRef, JSON.parse(document.getElementById('t2').value))">
</div>
<br>
<div>
  <div>Invite some user</div>
  <textarea id="t3" style="width:50%">b@example.com</textarea><br>
  <input type="submit" value="Send" onclick="invite(perma, document.getElementById('t3').value)">
</div>

<br>
<div>
  <input type="submit" value="Benchmark" onclick="benchmark()">
  <input type="submit" value="List permas" onclick="list()">
</div>

<h1>Result</h1>
<div id="out"></div>

<h1>Open</h1>
<div id="permas"></div>

<div>Logout <a href="{{logout}}">here</a>
<hr>
<address></address>
<!-- hhmts start --> Last modified: Fri Jul 29 02:46:53 CEST 2011 <!-- hhmts end -->

<script type="text/javascript">
  var tok = "{{token}}";
  var sessionID = "{{session}}";
  var userID = "{{userid}}";
  
  channel = new goog.appengine.Channel('{{token}}');
  socket = channel.open();
  socket.onopen = onOpened;
  socket.onmessage = onMessage;
  socket.onerror = onError;
  socket.onclose = onClose;

  function onOpened() {
    console.log("Opened channel")
  };

  function onClose() {
    console.log("Closed channel")
  };

  function onError() {
    console.log("Channel error")
  };

  function onMessage(msg) {
    console.log("Message: " + msg.data);
    document.getElementById("out").innerText = msg.data;

    var jmsg = JSON.parse(msg.data);
    PermaInfo.addOTNode(jmsg);
 };

  var perma = "";
  var entityBlobRef = "";

  var openPermas = { };

  function PermaInfo(perma) {
    this.perma = perma;
    this.seq = 0;
    this.queue = { };
    openPermas[perma] = this;
  };

  PermaInfo.get = function(perma) {
    var x = openPermas[perma];
    if ( x ) {
      return x;
    }
    x = new PermaInfo(perma);
    openPermas[perma] = x;
    return x;
  };

  PermaInfo.addOTNode = function(jmsg) {
    if (jmsg.type == "mutation") {
      PermaInfo.get(jmsg.perma).addMutation(jmsg);
    } else if (jmsg.type == "entity") {
      PermaInfo.get(jmsg.perma).addEntity(jmsg);
    } else if (jmsg.type == "keep") {
      PermaInfo.get(jmsg.perma).addKeep(jmsg);
    } else if (jmsg.type == "permission") {
      PermaInfo.get(jmsg.perma).addPermission(jmsg);
    }
  };
  
  PermaInfo.prototype.addMutation = function(mut) {
    this.addOTNode_(mut);
  };

  PermaInfo.prototype.addEntity = function(entity) {
    this.addOTNode_(entity);
  };

  PermaInfo.prototype.addKeep = function(keep) {
    this.addOTNode_(keep);
  };

  PermaInfo.prototype.addPermission = function(perm) {
    this.addOTNode_(perm);
  };

  PermaInfo.prototype.addOTNode_ = function(node) {
   if (node.seq < this.seq) {
      console.log("Received ot node twice")
      return;
    }
    if (node.seq > this.seq) {
      console.log("Queueing up ot node")
      this.queue[node.seq] = node;
      return;
    }
    this.seq++;
    console.log("Apply seq " + (this.seq - 1).toString() + " of " + node.perma);
    var next = this.queue[this.seq];
    if (next) {
      delete this.queue[this.seq];
      PermaInfo.addOTNode(next);
    }
  };

  PermaInfo.prototype.sequenceNumber = function() {
    return this.seq;
  };
  
  function create() {
    var f = function(msg) {
      var response = JSON.parse(msg);
      if ( response.error ) {
        alert(response.error);
        return;
      }
      perma = response.blobref;
      // Receive further updates
      open(perma);
    };
    post("/private/submit", "{\"type\":\"permanode\"}", f);
  };

  function entity(perma, content) {
    var f = function(msg) {
      console.log("Got: " + msg)
      var response = JSON.parse(msg);
      if ( response.error ) {
        alert(response.error);
        return;
      }
      entityBlobRef = response.blobref;
   };
    var msg = {perma: perma, content: content, type: "entity"};
    post("/private/submit", JSON.stringify(msg), f);
  };

  function open(perma) {
    var f = function(msg) {
      console.log("Got: " + msg)
      var response = JSON.parse(msg);
      if ( !response.ok ) {
        alert(reponse.error);
        return;
      };
      console.log("Opened perma");
      var pi = PermaInfo.get(perma)
    }
    post("/private/open", JSON.stringify({perma:perma, session:sessionID}), f);    
  }

  function invite(perma, user) {
    var f = function(msg) {
      console.log("Got: " + msg)
      var response = JSON.parse(msg);
      if ( !response.ok ) {
        alert(reponse.error);
        return;
      };
      console.log("Invited a user");
    }
    var pi = PermaInfo.get(perma);
    var msg = {type: "permission", perma: perma, allow: 1+2, deny:0, action:"invite", user: user, at: perma.sequenceNumber()};
   post("/private/submit", JSON.stringify(msg), f);    
  }
  
  function accept(perma, permission) {
    var f = function(msg) {
      console.log("Got: " + msg)
      var response = JSON.parse(msg);
      if ( !response.ok ) {
        alert(reponse.error);
        return;
      };
      console.log("Accepted an invitation");
    }
    var msg = {type: "keep", perma: perma, permission: permission}
    post("/private/submit", JSON.stringify(msg), f);    
  }

  function mutate(perma, entity, op) {
    var f = function(msg) {
      console.log("Got: " + msg)
      var response = JSON.parse(msg);
      if ( !response.ok ) {
        alert(response.error);
        return;
      };
      console.log("Mutation submitted");
    }
    var pi = PermaInfo.get(perma);
    var msg = {perma: perma, entity: entity, at: pi.sequenceNumber(), type: "mutation", op: op}
   post("/private/submit", JSON.stringify(msg), f);
  }

  function list(perma, permission) {
    var f = function(msg) {
      console.log("Got: " + msg)
      var response = JSON.parse(msg);
      if ( !response.ok ) {
        alert(reponse.error);
        return;
      };
      var div = document.getElementById("permas")
      for ( var i = 0; i < response.permas.length; i++ ) {
        var a = document.createElement("a");
        a.innerText = response.permas[i];
        a.href = "#"
        a.onclick = function(p) { return function() { open(p); } }(response.permas[i])
        div.appendChild(a)
        div.appendChild(document.createElement("br"))
      }
   }
   get("/private/listpermas", f);    
  }

  function post(url, data, f) {
    var xmlHttp = null;
    try {
      // Mozilla, Opera, Safari sowie Internet Explorer (ab v7)
      xmlHttp = new XMLHttpRequest();
    } catch(e) {
      try {
        // MS Internet Explorer (ab v6)
        xmlHttp  = new ActiveXObject("Microsoft.XMLHTTP");
      } catch(e) {
        try {
          // MS Internet Explorer (ab v5)
          xmlHttp  = new ActiveXObject("Msxml2.XMLHTTP");
        } catch(e) {
          xmlHttp  = null;
        }
      }
    }
    if (xmlHttp) {
      xmlHttp.open('POST', url, true);
      xmlHttp.onreadystatechange = function () {
        if (xmlHttp.readyState == 4) {
          document.getElementById("out").innerText = xmlHttp.responseText
          if ( f ) {
            f(xmlHttp.responseText)
          }
        }
      };
      xmlHttp.send(data);
    }
  }

  function get(url, f) {
    var xmlHttp = null;
    try {
      // Mozilla, Opera, Safari sowie Internet Explorer (ab v7)
      xmlHttp = new XMLHttpRequest();
    } catch(e) {
      try {
        // MS Internet Explorer (ab v6)
        xmlHttp  = new ActiveXObject("Microsoft.XMLHTTP");
      } catch(e) {
        try {
          // MS Internet Explorer (ab v5)
          xmlHttp  = new ActiveXObject("Msxml2.XMLHTTP");
        } catch(e) {
          xmlHttp  = null;
        }
      }
    }
    if (xmlHttp) {
      xmlHttp.open('GET', url, true);
      xmlHttp.onreadystatechange = function () {
        if (xmlHttp.readyState == 4) {
          document.getElementById("out").innerText = xmlHttp.responseText
          if ( f ) {
            f(xmlHttp.responseText)
          }
        }
      };
      xmlHttp.send();
    }
  }

  var benchCount = 0
  var benchStart = 0
  function benchmark() {
    var date = new Date()
    benchStart = date.getTime()
    benchmarkIntern();
  }
  function benchmarkIntern() {
    if ( benchCount == 100 ) {
      var date = new Date()
      console.log("DURATION: " + ((date.getTime() - benchStart)/1000).toString())
      return
    }
    console.log("Benchmark ...")
   var blob = {"type":"mutation", perma: perma, "at":2 + benchCount, "op":{"$t":[{"$s":11 + benchCount * 2}, "!?"]}}
    benchCount++
    post("/private/submit", JSON.stringify(blob), benchmarkIntern);
  }
</script>
</body> </html>
